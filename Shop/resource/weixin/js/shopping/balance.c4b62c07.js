!function(a,e,t,s){var i=function(){this.init()};i.prototype={params:{addressId:0,cartId:[],couponId:0,shippingId:0,credit:0,postscript:"",invPayee:0,invContent:"",address:[],credit:0,creditNum:0,creditMoney:0,goodsMoney:0},init:function(){this.initParams(),this.getData(),this.initEvent()},initParams:function(){var e=Pub.searchToObject();e.id?this.params.cartId[0]=e.id:this.params.cartId=JSON.parse(localStorage.getItem("cartIds")),this.params.addressId=localStorage.getItem("addressId"),this.params.postscript=a("#postscript").val()},getData:function(){var a=this;Pub.post("/Home/order/confirm",{cart_id:a.params.cartId},function(e){0===e.error_code&&(console.log(e),a.params.address=e.data.address,a.addressData(),a.goodsData(e.data.goods),a.conponData(e.data.coupons),a.params.credit=e.data.user_credit,a.params.creditMoney=e.data.credit_money,a.credit(),a.params.goodsMoney=e.data.money,a.totalMoney())})},addressData:function(){var e=this;if(null!=e.params.addressId)a("#select_address").empty(),Pub.post("/Home/UserAddress/detail",{id:e.params.addressId},function(e){if(0===e.error_code){a("#select_address").empty();var t="<em>&#xe6e2;</em><h4>"+e.data.consignee+"&nbsp;&nbsp;"+e.data.mobile.replace(e.data.mobile.substring(4,8),"****")+"</h4><p>"+e.data.province+"&nbsp;"+e.data.city+"&nbsp;"+e.data.district+"&nbsp;"+e.data.address+"</p><i>&#xe6d5;</i>";a("#select_address").append(t)}});else if(null===e.params.addressId&&null!=e.params.address){a("#select_address").empty();var t="<em>&#xe6e2;</em><h4>"+e.params.address.consignee+"&nbsp;&nbsp;"+e.params.address.mobile.replace(e.params.address.mobile.substring(4,8),"****")+"</h4><p>"+e.params.address.province+"&nbsp;"+e.params.address.city+"&nbsp;"+e.params.address.district+"&nbsp;"+e.params.address.address+"</p><i>&#xe6d5;</i>";a("#select_address").append(t),e.params.addressId=e.params.address.id}else if(null===e.params.address&&null==e.params.addressId){a("#select_address").empty();var t='<em>&#xe6e2;</em><h4>添加收货地址</h4><p class="warn">(您选择的地址可能造成订单的价格变化，请确认后再付款)</p><i>&#xe6d5;</i>';a("#select_address").append(t)}},goodsData:function(e){if(e&&e.length>0){a("#goods_list").empty();var t="";for(var s in e){t+='<li><a href="'+Pub.getHtmlUrl("html/goods/cont.fb80c266.html")+"?id="+e[s].goods_id+'"><div class="img"><span></span><img src="'+e[s].goods_img+'"></div><div class="info"><div class="name"><h3>'+e[s].goods_name+'</h3></div><div class="sizes">';var i=e[s].spec_key_name.split(" ");for(var d in i)t+="<h4>"+i[d]+"</h4>";t+='</div><div class="price"><span>￥ '+e[s].goods_price+"<del>￥"+e[s].market_price+"</del></span><em>X "+e[s].goods_num+"</em></div></div></a></li>"}a("#goods_list").append(t)}},conponData:function(e){var t=this;if(e&&e.length>0){a("#coupon_item").html("优惠券(请选择优惠券)"),a("#coupon").on("click",function(){a("#coupon-black").fadeIn(),a("#coupon-light").slideDown()}),a("#coupon-black").on("click",function(){a("#coupon-light").slideUp(),a("#coupon-black").fadeOut()}),a("#coupons").empty();var s="";for(var i in e)s+='<li data-index="'+e[i].id+'"><h3>'+e[i].title+":满"+e[i].condition+"立减<em>"+e[i].money+"</em>元</h3><p>使用期限   "+e[i].date+"</p><i>&#xe619;</i></li>";s+='<li data-index="0"><h3>不使用优惠券</h3><i>&#xe619;</i></li>',a("#coupons").append(s),a("#coupons li").on("click",function(){a(this).siblings().removeClass("active"),a(this).addClass("active");var e=a(this).attr("data-index"),s=a(this).find("h3").text(),i=a(this).find("em").text();a("#coupon_item").text("优惠券("+s+")"),0===parseInt(e)?a("#total_coupons").text("0.00"):a("#total_coupons").text(i),t.totalMoney()})}else a("#coupon_item").html("优惠券(无可用优惠券)"),a("#total_coupons").text("0.00"),t.totalMoney()},credit:function(){var e=this;0===parseInt(e.params.credit)?(a("#user_credit").html("<strong>您目前没有积分！</strong>"),a("#total_credit").text("0.00"),e.params.creditNum=0):(a("#credit").text(e.params.credit),a("#credit_money").text(e.params.creditMoney),a("#user_credit").on("click",function(){a(this).find("label").is(".active")?(a(this).find("label").removeClass("active"),e.params.creditNum=0,a("#total_credit").text("0.00"),e.totalMoney()):(a(this).find("label").addClass("active"),e.params.creditNum=e.params.credit,a("#total_credit").text(e.params.creditMoney),e.totalMoney())}))},totalMoney:function(){var e=this;a("#total_money").text(parseInt(e.params.goodsMoney));var t=parseInt(e.params.goodsMoney)+parseInt(a("#total_fare").text())-parseInt(a("#total_coupons").text())-parseInt(a("#total_credit").text());a("#total_pay_money").text(t.toFixed(2))},addOrderPay:function(){var a=this;Pub.post("/Home/order/add",{address_id:a.params.addressId,cart_id:a.params.cartId,coupons_id:a.params.couponId,shipping_id:0,credit:a.params.creditNum,postscript:a.params.postscript,inv_payee:a.params.invPayee,inv_content:a.params.invContent},function(e){console.log(e),0===e.error_code&&(console.log(e),cloud.loading("正在跳转支付！",2e3),setTimeout(function(){Pub.post("/Home/Pay/toPay",{order_id:e.data.order_id},function(e){console.log(e),0===e.error_code?a.payCall(e.data.jsApiParameters):cloud.explain(e.message,2e3)})},1500))})},initEvent:function(){var e=this;a("#select_address").on("click",function(){var a="html/shopping/balance.a20704ba.html";localStorage.setItem("balanceUrl",a),null!=e.params.addressId||null!=e.params.address?location.href=Pub.getHtmlUrl("html/shopping/address-list.1d9efda1.html"):null===e.params.address&&null==e.params.addressId&&(location.href=Pub.getHtmlUrl("html/shopping/address.f0b8005f.html"))}),a(".btn-full-red").on("click",function(){a("#coupon-light").slideUp(),a("#coupon-black").fadeOut()}),a("#bill").on("click",function(){a("#bill-show").is(":hidden")?a("#bill-show").show():a("#bill-show").hide()}),a("#bill-show label").on("click",function(){a(this).siblings().removeClass("active"),a(this).addClass("active");var t=a(this).attr("data-index");e.params.invPayee=t,3===parseInt(t)?(a("#bill-form").show(),""!=a("#bill-form input").val()&&(e.params.invContent=a("#bill-form input").val())):a("#bill-form").hide()}),a("#submit_add_order").on("click",function(){0===parseInt(e.params.addressId)?cloud.explain("请选择收货地址",3e3):0===parseInt(e.params.invPayee)?cloud.explain("请选择发票类型，单位发票请填写公司名称",3e3):3===parseInt(e.params.invPayee)&&""==a("#bill-form input").val()?cloud.explain("单位发票请填写公司名称",3e3):e.addOrderPay()})},apiCall:function(a){var e=jQuery.parseJSON(a);WeixinJSBridge.invoke("getBrandWCPayRequest",e,function(a){"get_brand_wcpay_request:ok"==a.err_msg?(cloud.explain("支付成功！！！","success",3e3),setTimeout(function(){location.href=Pub.getHtmlUrl("html/user/user-order.ac9cef1c.html")},3e3)):cloud.alert("支付失败！！！",function(){location.href=Pub.getHtmlUrl("html/user/user-order-daiFuKuan.9bd09458.html")})})},payCall:function(a){var e=this;"undefined"==typeof WeixinJSBridge?t.addEventListener?t.addEventListener("WeixinJSBridgeReady",e.apiCall(a),!1):t.attachEvent&&(t.attachEvent("WeixinJSBridgeReady",e.apiCall(a)),t.attachEvent("onWeixinJSBridgeReady",e.apiCall(a))):e.apiCall(a)}},new i}(jQuery,window,document);